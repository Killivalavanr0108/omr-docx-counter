<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OMR DOCX K-Level Counter</title>
  <!-- Mammoth.js for DOCX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #e6f4ff; }
    h1 { text-align: center; color: #003366; }
    .college-header {
      display: flex; align-items: center; justify-content: center;
      background: #b3daff; padding: 15px; border-radius: 10px; margin-bottom: 20px;
    }
    .college-header img { height: 80px; margin-right: 20px; border-radius: 8px; }
    .college-header h2 { margin: 0; color: #003366; }
    .upload-box {
      text-align: center; margin: 20px auto; padding: 30px;
      border: 2px dashed #3399ff; border-radius: 10px; background: #cce6ff; width: 460px;
    }
    input[type="file"] { margin-top: 10px; }
    #status { text-align: center; margin: 20px; font-weight: bold; color: #003366; }
    #student-info {
      background: #ffffff; padding: 15px; margin: 20px auto; width: 600px;
      border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,.1); font-size: 16px;
    }
    #results {
      background: #ffffff; padding: 20px; margin: 20px auto; width: 600px;
      border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,.1);
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #99ccff; padding: 8px; text-align: center; }
    th { background: #b3daff; }
    td { font-weight: bold; }
    ul { list-style-type: none; padding: 0; }
    ul li { margin: 5px 0; }
    .answered { color: green; font-weight: bold; }
    .unanswered { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <div class="college-header">
    <!-- College Logo -->
    <img src="college_token.avif" alt="College Logo">
    <div>
      <h2>Government Arts College, Nandanam, Chennai-35</h2>
    </div>
  </div>

  <h1>OMR DOCX K-Level Counter</h1>

  <div class="upload-box">
    <p>Select a <b>.docx</b> file to process:</p>
    <input type="file" id="fileInput" accept=".docx">
  </div>

  <div id="status"></div>
  <div id="student-info"></div>
  <div id="results"></div>

  <script>
    document.getElementById("fileInput").addEventListener("change", handleFile);

    async function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      setStatus("⏳ Processing file...");
      setResults("");
      setStudentInfo("");

      try {
        const extractedText = await extractText(file);
        const { className, subjectCode, regNo } = extractStudentInfo(extractedText);
        const { counts, total, unanswered, details } = countKLevels(extractedText);

        // Student info section
        let studentHtml = "<h3>Student Information</h3><table>";
        studentHtml += `<tr><td><b>Class</b></td><td>${className || "Not Found"}</td></tr>`;
        studentHtml += `<tr><td><b>Subject Code</b></td><td>${subjectCode || "Not Found"}</td></tr>`;
        studentHtml += `<tr><td><b>Register No</b></td><td>${regNo || "Not Found"}</td></tr>`;
        studentHtml += "</table>";
        setStudentInfo(studentHtml);

        // Render results
        let html = "<h3>K-Level Counts</h3>";
        html += "<table><tr><th>K-Level</th><th>Count</th></tr>";
        for (const k of ["K1","K2","K3","K4","K5","K6"]) {
          html += `<tr><td>${k}</td><td>${counts[k]}</td></tr>`;
        }
        html += `<tr><td><b>Total Answered</b></td><td><b>${total}</b></td></tr>`;
        html += `<tr><td><b> Total Unanswered</b></td><td><b>${unanswered}</b></td></tr>`;
        html += `<tr><td><b>Total Questions</b></td><td><b>${details.length}</b></td></tr>`;
        html += "</table>";

        // Question-wise details
        html += "<h3>Question-wise Answers</h3><ul>";
        details.forEach((d, idx) => {
          if (d.pickedK) {
            html += `<li>Q${idx+1}: <span class="answered">${d.pickedK}</span></li>`;
          } else {
            html += `<li>Q${idx+1}: <span class="unanswered">Unanswered ❌</span></li>`;
          }
        });
        html += "</ul>";

        setResults(html);
        setStatus("✅ Done");
      } catch (err) {
        setStatus("❌ Error: " + err.message);
      }
    }

    function setStatus(msg) { document.getElementById("status").innerText = msg; }
    function setResults(html) { document.getElementById("results").innerHTML = html; }
    function setStudentInfo(html) { document.getElementById("student-info").innerHTML = html; }

    async function extractText(file) {
      const arrayBuffer = await file.arrayBuffer();
      const res = await mammoth.extractRawText({ arrayBuffer });
      return res.value || "";
    }

    function extractStudentInfo(text) {
      // Match "Class ... Subject Code ..." on same line
      const classLine = text.match(/Class[:\- ]*([A-Za-z0-9. ]+)\s+Subject\s*Code[:\- ]*([A-Za-z0-9]+)/i);

      // Match Register No
      const regMatch = text.match(/Register\s*No[:.\- ]+([A-Za-z0-9]+)/i);

      return {
        className: classLine ? classLine[1].trim() : null,
        subjectCode: classLine ? classLine[2].trim() : null,
        regNo: regMatch ? regMatch[1].trim() : null
      };
    }

    function countKLevels(rawText) {
      const counts = { K1:0, K2:0, K3:0, K4:0, K5:0, K6:0 };
      const lines = rawText.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

      const isNumber = s => /^\d+[.)]?$/.test(s);
      const isMark = s => /\(●\)|●|•|■|✓|x/i.test(s);

      const details = [];
      for (let i = 0; i < lines.length; i++) {
        if (isNumber(lines[i])) {
          const marks = [];
          let j = i + 1;
          while (j < lines.length && marks.length < 6) {
            if (lines[j] !== "") marks.push(lines[j]);
            j++;
          }
          if (marks.length === 6) {
            const pickedIndex = marks.findIndex(isMark);
            if (pickedIndex >= 0) {
              counts["K" + (pickedIndex+1)]++;
            }
            details.push({ q: lines[i], pickedK: pickedIndex>=0 ? "K"+(pickedIndex+1) : null });
            i = j - 1;
          }
        }
      }

      const total = Object.values(counts).reduce((a,b)=>a+b,0);
      const unanswered = details.filter(d => !d.pickedK).length;
      return { counts, total, unanswered, details };
    }
  </script>
</body>
</html>
