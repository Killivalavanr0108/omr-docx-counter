<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OMR DOCX K-Level Counter</title>
  <script>
  document.getElementById("fileInput").addEventListener("change", handleFile);

  async function handleFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    document.getElementById("status").innerText = "⏳ Processing DOCX...";
    document.getElementById("results").innerHTML = "";

    const arrayBuffer = await file.arrayBuffer();

    try {
      // Extract raw text from DOCX
      let result = await mammoth.extractRawText({ arrayBuffer });
      let extractedText = result.value;

      let kLevels = { K1: 0, K2: 0, K3: 0, K4: 0, K5: 0, K6: 0 };

      // Split into lines
      let lines = extractedText.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

      // Find rows that contain (o) or (●)
      lines.forEach(line => {
        if (line.includes("(o)") || line.includes("●")) {
          let matches = line.match(/\(●\)/g);
          if (matches) {
            // Find which K it belongs to by column order
            let cols = line.split(/\s+/); // split by spaces
            cols.forEach((col, idx) => {
              if (col.includes("●")) {
                let kName = "K" + (idx + 1);
                if (kLevels[kName] !== undefined) {
                  kLevels[kName]++;
                }
              }
            });
          }
        }
      });

      // Display results
      let output = "<h3>K-Level Counts:</h3>";
      for (let k in kLevels) {
        output += `<div class="k-count">${k}: ${kLevels[k]}</div>`;
      }
      let total = Object.values(kLevels).reduce((a,b)=>a+b,0);
      output += `<div class="k-count"><b>Total: ${total}</b></div>`;

      document.getElementById("results").innerHTML = output;
      document.getElementById("status").innerText = "✅ Processing complete!";
    } catch (err) {
      document.getElementById("status").innerText = "❌ Error: " + err.message;
    }
  }
</script>
</body>
</html>
